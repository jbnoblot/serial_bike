<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSerial avec Protocol Buffers</title>
</head>
<body>
  <h1>Contrôle via WebSerial</h1>
  <button id="connect">Connecter au port série</button>
  <button id="send">Envoyer un message</button>
  <select id="action">
    <option value="connexion">Connexion</option>
    <option value="deconnexion">Déconnexion</option>
    <option value="borne_occupee">Borne Occupée</option>
    <option value="borne_liberee">Borne Libérée</option>
    <option value="batterie">Batterie</option>
  </select>
  <script src="//cdn.jsdelivr.net/npm/protobufjs@7.X.X/dist/protobuf.min.js"></script>
  <script type="module">
    let port;
    let writer;
    let root;

    // Charger le fichier .proto
    protobuf.load("./uart.proto").then(loadedRoot => {
      root = loadedRoot;
      console.log("Fichier .proto chargé avec succès !");
    }).catch(err => {
      console.error("Erreur lors du chargement du fichier .proto :", err);
    });

    document.getElementById('connect').addEventListener('click', async () => {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        writer = port.writable.getWriter();
        console.log('Port série connecté');
      } catch (err) {
        console.error('Erreur de connexion au port série:', err);
      }
    });

    document.getElementById('send').addEventListener('click', async () => {
      if (!writer) {
        alert('Connectez d\'abord au port série.');
        return;
      }

      const action = document.getElementById('action').value;
      let message;

      // Obtenir les types de messages depuis le fichier .proto
      const DeviceMessage = root.lookupType("vlock.uart.DeviceMessage");
      const Connexion = root.lookupType("vlock.uart.Connexion");
      const Deconnexion = root.lookupType("vlock.uart.Deconnexion");
      const BorneOccupee = root.lookupType("vlock.uart.BorneOccupee");
      const BorneLiberee = root.lookupType("vlock.uart.BorneLiberee");
      const Batterie = root.lookupType("vlock.uart.Batterie");

      switch (action) {
        case 'connexion':
          const connexionPayload = { heartbeat: 60 }; // Exemple de valeur
          const connexionMessage = Connexion.create(connexionPayload);
          message = DeviceMessage.create({ connexion: connexionMessage });
          break;

        case 'deconnexion':
          message = DeviceMessage.create({ deconnexion: {} });
          break;

        case 'borne_occupee':
          const borneOccupeePayload = {
            borne_id: 1,
            cadenas: 'G',
            user_id: 'user_001'
          };
          const borneOccupeeMessage = BorneOccupee.create(borneOccupeePayload);
          message = DeviceMessage.create({ borne_occupee: borneOccupeeMessage });
          break;

        case 'borne_liberee':
          const borneLibereePayload = {
            borne_id: 1,
            cadenas: 'G'
          };
          const borneLibereeMessage = BorneLiberee.create(borneLibereePayload);
          message = DeviceMessage.create({ borne_liberee: borneLibereeMessage });
          break;

        case 'batterie':
          const batteriePayload = { niveau_batterie: 85 }; // Exemple de valeur
          const batterieMessage = Batterie.create(batteriePayload);
          message = DeviceMessage.create({ batterie: batterieMessage });
          break;

        default:
          alert('Action non reconnue.');
          return;
      }

      // Sérialiser le message en binaire
      const binaryMessage = DeviceMessage.encode(message).finish();

      // Envoyer le message via Web Serial
      try {
        await writer.write(binaryMessage);
        console.log('Message envoyé:', binaryMessage);
      } catch (err) {
        console.error('Erreur lors de l\'envoi du message:', err);
      }
    });
  </script>
</body>
</html>