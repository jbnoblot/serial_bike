<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSerial avec Protocol Buffers</title>
</head>
<body>
  <h1>Contrôle via WebSerial</h1>
  <button id="connect">Connecter au port série</button>
  <button id="send">Envoyer un message</button>
  <select id="action">
    <option value="connexion">Connexion</option>
    <option value="deconnexion">Déconnexion</option>
    <option value="borne_occupee">Borne Occupée</option>
    <option value="borne_liberee">Borne Libérée</option>
    <option value="batterie">Batterie</option>
  </select>
  <div id="form-container"></div>
  <script src="//cdn.jsdelivr.net/npm/protobufjs@7.X.X/dist/protobuf.min.js"></script>
  <script type="module">
    let port;
    let writer;
    let root;
 // Charger le fichier .proto
 protobuf.load("./uart.proto").then(loadedRoot => {
    root = loadedRoot;
    console.log("Fichier .proto chargé avec succès !");
  }).catch(err => {
    console.error("Erreur lors du chargement du fichier .proto :", err);
  });

  // Générer dynamiquement un formulaire pour le message sélectionné
  document.getElementById('action').addEventListener('change', () => {
    const action = document.getElementById('action').value;
    const formContainer = document.getElementById('form-container');
    formContainer.innerHTML = ''; // Réinitialiser le formulaire

    let messageType;
    switch (action) {
      case 'connexion':
        messageType = root.lookupType("vlock.uart.Connexion");
        break;
      case 'deconnexion':
        messageType = root.lookupType("vlock.uart.Deconnexion");
        break;
      case 'borne_occupee':
        messageType = root.lookupType("vlock.uart.BorneOccupee");
        break;
      case 'borne_liberee':
        messageType = root.lookupType("vlock.uart.BorneLiberee");
        break;
      case 'batterie':
        messageType = root.lookupType("vlock.uart.Batterie");
        break;
      default:
        return;
    }

    // Introspecter les champs du message et générer un formulaire
    if (messageType) {
      const fields = messageType.fields;
      for (const [fieldName, fieldInfo] of Object.entries(fields)) {
        const label = document.createElement('label');
        label.textContent = `${fieldName} (${fieldInfo.type})`;
        label.htmlFor = fieldName;

        const input = document.createElement('input');
        input.id = fieldName;
        input.name = fieldName;
        input.type = 'text'; // Par défaut, utiliser un champ texte
        input.placeholder = `Entrez ${fieldName}`;

        formContainer.appendChild(label);
        formContainer.appendChild(input);
        formContainer.appendChild(document.createElement('br'));
      }
    }
  });

  // Connecter au port série
  document.getElementById('connect').addEventListener('click', async () => {
    try {
      port = await navigator.serial.requestPort();
      await port.open({ baudRate: 9600 });
      writer = port.writable.getWriter();
      console.log('Port série connecté');
    } catch (err) {
      console.error('Erreur de connexion au port série:', err);
    }
  });

  // Envoyer le message via Web Serial
  document.getElementById('send').addEventListener('click', async () => {
    if (!writer) {
      alert('Connectez d\'abord au port série.');
      return;
    }

    const action = document.getElementById('action').value;
    const formContainer = document.getElementById('form-container');
    const inputs = formContainer.querySelectorAll('input');
    const payload = {};

    // Récupérer les valeurs des champs du formulaire
    inputs.forEach(input => {
      payload[input.name] = isNaN(input.value) ? input.value : Number(input.value);
    });

    let message;
    const DeviceMessage = root.lookupType("vlock.uart.DeviceMessage");

    switch (action) {
      case 'connexion':
        const Connexion = root.lookupType("vlock.uart.Connexion");
        const connexionMessage = Connexion.create(payload);
        message = DeviceMessage.create({ connexion: connexionMessage });
        break;

      case 'deconnexion':
        message = DeviceMessage.create({ deconnexion: {} });
        break;

      case 'borne_occupee':
        const BorneOccupee = root.lookupType("vlock.uart.BorneOccupee");
        const borneOccupeeMessage = BorneOccupee.create(payload);
        message = DeviceMessage.create({ borneOccupee: borneOccupeeMessage });
        break;

      case 'borne_liberee':
        const BorneLiberee = root.lookupType("vlock.uart.BorneLiberee");
        const borneLibereeMessage = BorneLiberee.create(payload);
        message = DeviceMessage.create({ borneLiberee: borneLibereeMessage });
        break;

      case 'batterie':
        const Batterie = root.lookupType("vlock.uart.Batterie");
        const batterieMessage = Batterie.create(payload);
        message = DeviceMessage.create({ batterie: batterieMessage });
        break;

      default:
        alert('Action non reconnue.');
        return;
    }

    // Sérialiser le message en binaire
    const binaryMessage = DeviceMessage.encode(message).finish();

    // Envoyer le message via Web Serial
    try {
      await writer.write(binaryMessage);
      console.log('Message envoyé:', binaryMessage);
    } catch (err) {
      console.error('Erreur lors de l\'envoi du message:', err);
    }
  });
</script>
</body>
</html>